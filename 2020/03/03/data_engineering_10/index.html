<!DOCTYPE html>
<html>
<head><meta name="generator" content="Hexo 3.9.0">
    <meta charset="utf-8">

    

    
    <title>data engineering (데이터 모델링 및 챗봇 만들기) | DataLatte&#39;s IT Blog</title>
    
    <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">
    
        <meta name="keywords" content>
    
    
    <meta name="description" content="Spotify 데이터 유사도 모델링 모든 track을 다 유클리디안 거리를 계산해서 유사도를 측정하기에는 많은 양이기 때문에 해당 Artist의 track들의 audio feature 데이터에 대해 평균을 낸 값을 사용하여 Artist 끼리의 유사도를 계산할 것이다. 해당 유사도를 계산하기 위해 아래와 같이 먼저 RDS에 접속하여 table을 생성해 준다.">
<meta property="og:type" content="article">
<meta property="og:title" content="data engineering (데이터 모델링 및 챗봇 만들기)">
<meta property="og:url" content="https://heung-bae-lee.github.io/2020/03/03/data_engineering_10/index.html">
<meta property="og:site_name" content="DataLatte&#39;s IT Blog">
<meta property="og:description" content="Spotify 데이터 유사도 모델링 모든 track을 다 유클리디안 거리를 계산해서 유사도를 측정하기에는 많은 양이기 때문에 해당 Artist의 track들의 audio feature 데이터에 대해 평균을 낸 값을 사용하여 Artist 끼리의 유사도를 계산할 것이다. 해당 유사도를 계산하기 위해 아래와 같이 먼저 RDS에 접속하여 table을 생성해 준다.">
<meta property="og:locale" content="en">
<meta property="og:image" content="https://heung-bae-lee.github.io/image/Athena_similarity_table_create.png">
<meta property="og:updated_time" content="2020-03-09T14:06:21.058Z">
<meta name="twitter:card" content="summary">
<meta name="twitter:title" content="data engineering (데이터 모델링 및 챗봇 만들기)">
<meta name="twitter:description" content="Spotify 데이터 유사도 모델링 모든 track을 다 유클리디안 거리를 계산해서 유사도를 측정하기에는 많은 양이기 때문에 해당 Artist의 track들의 audio feature 데이터에 대해 평균을 낸 값을 사용하여 Artist 끼리의 유사도를 계산할 것이다. 해당 유사도를 계산하기 위해 아래와 같이 먼저 RDS에 접속하여 table을 생성해 준다.">
<meta name="twitter:image" content="https://heung-bae-lee.github.io/image/Athena_similarity_table_create.png">
<meta property="fb:app_id" content="100003222637819">


    <link rel="canonical" href="https://heung-bae-lee.github.io/2020/03/03/data_engineering_10/">

    

    

    <link rel="stylesheet" href="/libs/font-awesome/css/font-awesome.min.css">
    <link rel="stylesheet" href="/libs/titillium-web/styles.css">
    <link rel="stylesheet" href="/libs/source-code-pro/styles.css">

    <link rel="stylesheet" href="/css/style.css">

    <script src="/libs/jquery/3.3.1/jquery.min.js"></script>
    
    
        <link rel="stylesheet" href="/libs/lightgallery/css/lightgallery.min.css">
    
    
        <link rel="stylesheet" href="/libs/justified-gallery/justifiedGallery.min.css">
    
    
        <script type="text/javascript">
(function(i,s,o,g,r,a,m) {i['GoogleAnalyticsObject']=r;i[r]=i[r]||function() {
(i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
})(window,document,'script','//www.google-analytics.com/analytics.js','ga');

ga('create', 'UA-154199624-1', 'auto');
ga('send', 'pageview');

</script>

    
    


    <script async src="https://pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
<!-- 상단형 -->
<ins class="adsbygoogle" style="display:block" data-ad-client="ca-pub-4604833066889492" data-ad-slot="4588503508" data-ad-format="auto" data-full-width-responsive="true"></ins>
<script>
     (adsbygoogle = window.adsbygoogle || []).push({});
</script>

<link rel="alternate" href="/rss2.xml" title="DataLatte's IT Blog" type="application/rss+xml">
</head>
</html>
<body>
    <div id="wrap">
        <header id="header">
    <div id="header-outer" class="outer">
        <div class="container">
            <div class="container-inner">
                <div id="header-title">
                    <h1 class="logo-wrap">
                        <a href="/" class="logo"></a>
                    </h1>
                    
                        <h2 class="subtitle-wrap">
                            <p class="subtitle">DataLatte&#39;s IT Blog using Hexo</p>
                        </h2>
                    
                </div>
                <div id="header-inner" class="nav-container">
                    <a id="main-nav-toggle" class="nav-icon fa fa-bars"></a>
                    <div class="nav-container-inner">
                        <ul id="main-nav">
                            
                                <li class="main-nav-list-item" >
                                    <a class="main-nav-list-link" href="/">Home</a>
                                </li>
                            
                                        <ul class="main-nav-list"><li class="main-nav-list-item"><a class="main-nav-list-link" href="/categories/Bayes/">Bayes</a></li><li class="main-nav-list-item"><a class="main-nav-list-link" href="/categories/C-C-자료구조/">C/C++/자료구조</a></li><li class="main-nav-list-item"><a class="main-nav-list-link" href="/categories/CS231n/">CS231n</a></li><li class="main-nav-list-item"><a class="main-nav-list-link" href="/categories/Front-end/">Front end</a></li><li class="main-nav-list-item"><a class="main-nav-list-link" href="/categories/Kaggle/">Kaggle</a></li><li class="main-nav-list-item"><a class="main-nav-list-link" href="/categories/NLP/">NLP</a></li><li class="main-nav-list-item"><a class="main-nav-list-link" href="/categories/Python/">Python</a></li><li class="main-nav-list-item"><a class="main-nav-list-link" href="/categories/Recommendation-System/">Recommendation System</a></li><li class="main-nav-list-item"><a class="main-nav-list-link" href="/categories/Statistics-Mathematical-Statistics/">Statistics - Mathematical Statistics</a></li><li class="main-nav-list-item"><a class="main-nav-list-link" href="/categories/crawling/">crawling</a></li><li class="main-nav-list-item"><a class="main-nav-list-link" href="/categories/data-engineering/">data engineering</a></li><li class="main-nav-list-item"><a class="main-nav-list-link" href="/categories/deep-learning/">deep learning</a></li><li class="main-nav-list-item"><a class="main-nav-list-link" href="/categories/growth-hacking/">growth hacking</a></li><li class="main-nav-list-item"><a class="main-nav-list-link" href="/categories/hexo/">hexo</a></li><li class="main-nav-list-item"><a class="main-nav-list-link" href="/categories/linear-algebra/">linear algebra</a></li><li class="main-nav-list-item"><a class="main-nav-list-link" href="/categories/machine-learning/">machine learning</a></li></ul>
                                    
                                <li class="main-nav-list-item" >
                                    <a class="main-nav-list-link" href="/about/index.html">About</a>
                                </li>
                            
                        </ul>
                        <nav id="sub-nav">
                            <div id="search-form-wrap">

    <form class="search-form">
        <input type="text" class="ins-search-input search-form-input" placeholder="Search" />
        <button type="submit" class="search-form-submit"></button>
    </form>
    <div class="ins-search">
    <div class="ins-search-mask"></div>
    <div class="ins-search-container">
        <div class="ins-input-wrapper">
            <input type="text" class="ins-search-input" placeholder="Type something..." />
            <span class="ins-close ins-selectable"><i class="fa fa-times-circle"></i></span>
        </div>
        <div class="ins-section-wrapper">
            <div class="ins-section-container"></div>
        </div>
    </div>
</div>
<script>
(function (window) {
    var INSIGHT_CONFIG = {
        TRANSLATION: {
            POSTS: 'Posts',
            PAGES: 'Pages',
            CATEGORIES: 'Categories',
            TAGS: 'Tags',
            UNTITLED: '(Untitled)',
        },
        ROOT_URL: '/',
        CONTENT_URL: '/content.json',
    };
    window.INSIGHT_CONFIG = INSIGHT_CONFIG;
})(window);
</script>
<script src="/js/insight.js"></script>

</div>
                        </nav>
                    </div>
                </div>
            </div>
        </div>
    </div>
</header>

        <div class="container">
            <div class="main-body container-inner">
                <div class="main-body-inner">
                    <section id="main">
                        <div class="main-body-header">
    <h1 class="header">
    
    <a class="page-title-link" href="/categories/data-engineering/">data engineering</a>
    </h1>
</div>

                        <div class="main-body-content">
                            <script async src="https://pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
<!-- 상단형 -->
<ins class="adsbygoogle"
     style="display:block"
     data-ad-client="ca-pub-4604833066889492"
     data-ad-slot="4588503508"
     data-ad-format="auto"
     data-full-width-responsive="true"></ins>
<script>
     (adsbygoogle = window.adsbygoogle || []).push({});
</script>

			    <article id="post-data_engineering_10" class="article article-single article-type-post" itemscope itemprop="blogPost">
    <div class="article-inner">
        
            <header class="article-header">
                
    
        <h1 class="article-title" itemprop="name">
        data engineering (데이터 모델링 및 챗봇 만들기)
        </h1>
    

            </header>
        
        
            <div class="article-meta">
                
    <div class="article-date">
        <a href="/2020/03/03/data_engineering_10/" class="article-date">
            <time datetime="2020-03-03T14:29:20.000Z" itemprop="datePublished">2020-03-03</time>
        </a>
    </div>

		

                
            </div>
        
        
        <div class="article-entry" itemprop="articleBody">
            <h1 id="Spotify-데이터-유사도-모델링"><a href="#Spotify-데이터-유사도-모델링" class="headerlink" title="Spotify 데이터 유사도 모델링"></a>Spotify 데이터 유사도 모델링</h1><ul>
<li>모든 track을 다 유클리디안 거리를 계산해서 유사도를 측정하기에는 많은 양이기 때문에 해당 Artist의 track들의 audio feature 데이터에 대해 평균을 낸 값을 사용하여 Artist 끼리의 유사도를 계산할 것이다. 해당 유사도를 계산하기 위해 아래와 같이 먼저 RDS에 접속하여 table을 생성해 준다.</li>
</ul>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">mysql -h spotify.cgaj5rvtgf25.ap-northeast-2.rds.amazonaws.com -P 3306 -u hb0619 -p</span><br><span class="line"></span><br><span class="line">CREATE TABLE related_artists (artist_id VARCHAR(255), y_artist VARCHAR(255), distance FLOAT, PRIMARY KEY(artist_id, y_artist)) ENGINE=InnoDB DEFAULT CHARSET=utf8;</span><br></pre></td></tr></table></figure>
<ul>
<li>그 다음은 우리가 미리 만들어놓았던 Athena의 DataBase는 무엇이었는지를 확인하자. 필자는 아래와 같이 따로 Database를 만들지 않고 default로 사용했다. 또한, 입력했었던 날짜를 확인해놓아야 추후에 코드 작성시 Athena로 접속하여 만들어진 테이블들을 참조할 수 있다.</li>
</ul>
<p><img src="/image/Athena_similarity_table_create.png" alt="Athena database"></p>
<ul>
<li><p>필자는 Athena에 미리 만들어놓았던 두가지 top_tracks와 audio_features 테이블을 이용하여 유사도를 구하고 해당 유사도를 MySQL DB에 insert하는 방식으로 작업을 진행 할 것이다.</p>
</li>
<li><p>data_modeling.py</p>
</li>
</ul>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br></pre></td><td class="code"><pre><span class="line">import sys</span><br><span class="line">import os</span><br><span class="line">import logging</span><br><span class="line">import pymysql</span><br><span class="line">import boto3</span><br><span class="line">import time</span><br><span class="line">import math</span><br><span class="line"></span><br><span class="line">host = <span class="string">"end-point url"</span></span><br><span class="line">port = you port number</span><br><span class="line">username = <span class="string">"your MYSQL DB ID"</span></span><br><span class="line">database = <span class="string">"your MYSQL DB Name"</span></span><br><span class="line">password = <span class="string">"your MYSQL DB Password"</span></span><br><span class="line"></span><br><span class="line">def main():</span><br><span class="line"></span><br><span class="line">    try:</span><br><span class="line">        conn = pymysql.connect(host, user=username, passwd=password, db=database, port=port, use_unicode=True, charset=<span class="string">'utf8'</span>)</span><br><span class="line">        cursor = conn.cursor()</span><br><span class="line">    except:</span><br><span class="line">        logging.error(<span class="string">"could not connect to rds"</span>)</span><br><span class="line">        sys.exit(1)</span><br><span class="line"></span><br><span class="line">    athena = boto3.client(<span class="string">'athena'</span>)</span><br><span class="line"></span><br><span class="line">    query = <span class="string">""</span><span class="string">"</span></span><br><span class="line"><span class="string">        SELECT</span></span><br><span class="line"><span class="string">         artist_id,</span></span><br><span class="line"><span class="string">         AVG(danceability) AS danceability,</span></span><br><span class="line"><span class="string">         AVG(energy) AS energy,</span></span><br><span class="line"><span class="string">         AVG(loudness) AS loudness,</span></span><br><span class="line"><span class="string">         AVG(speechiness) AS speechiness,</span></span><br><span class="line"><span class="string">         AVG(acousticness) AS acousticness,</span></span><br><span class="line"><span class="string">         AVG(instrumentalness) AS instrumentalness</span></span><br><span class="line"><span class="string">        FROM</span></span><br><span class="line"><span class="string">         top_tracks t1</span></span><br><span class="line"><span class="string">        JOIN</span></span><br><span class="line"><span class="string">         audio_features t2 ON t2.id = t1.id AND CAST(t1.dt AS DATE) = DATE('2020-02-24') AND CAST(t2.dt AS DATE) = DATE('2020-02-24')</span></span><br><span class="line"><span class="string">        GROUP BY t1.artist_id</span></span><br><span class="line"><span class="string">    "</span><span class="string">""</span></span><br><span class="line">    <span class="comment"># 위에서 DATE를 정하는 부분에서 CAST(t1.dt AS DATE) = CURRENT_DATE - INTERVAL '1' DAY 이렇게 현재날짜를 기준으로 차이나는 기간을 통해 정해줄 수 있다.</span></span><br><span class="line">    <span class="comment"># 필자는 여러번 Athena에 실행하지 않았기 때문에 최근에 Athena에 만들어 놓은 위의 두 테이블의 데이터를 직접 보고 날짜를 지정했다.</span></span><br><span class="line"></span><br><span class="line">    r = query_athena(query, athena)</span><br><span class="line">    results = get_query_result(r[<span class="string">'QueryExecutionId'</span>], athena)</span><br><span class="line">    artists = process_data(results)</span><br><span class="line"></span><br><span class="line">    query = <span class="string">""</span><span class="string">"</span></span><br><span class="line"><span class="string">        SELECT</span></span><br><span class="line"><span class="string">         MIN(danceability) AS danceability_min,</span></span><br><span class="line"><span class="string">         MAX(danceability) AS danceability_max,</span></span><br><span class="line"><span class="string">         MIN(energy) AS energy_min,</span></span><br><span class="line"><span class="string">         MAX(energy) AS energy_max,</span></span><br><span class="line"><span class="string">         MIN(loudness) AS loudness_min,</span></span><br><span class="line"><span class="string">         MAX(loudness) AS loudness_max,</span></span><br><span class="line"><span class="string">         MIN(speechiness) AS speechiness_min,</span></span><br><span class="line"><span class="string">         MAX(speechiness) AS speechiness_max,</span></span><br><span class="line"><span class="string">         ROUND(MIN(acousticness),4) AS acousticness_min,</span></span><br><span class="line"><span class="string">         MAX(acousticness) AS acousticness_max,</span></span><br><span class="line"><span class="string">         MIN(instrumentalness) AS instrumentalness_min,</span></span><br><span class="line"><span class="string">         MAX(instrumentalness) AS instrumentalness_max</span></span><br><span class="line"><span class="string">        FROM</span></span><br><span class="line"><span class="string">         audio_features</span></span><br><span class="line"><span class="string">    "</span><span class="string">""</span></span><br><span class="line">    r = query_athena(query, athena)</span><br><span class="line">    results = get_query_result(r[<span class="string">'QueryExecutionId'</span>], athena)</span><br><span class="line">    avgs = process_data(results)[0]</span><br><span class="line"></span><br><span class="line">    metrics = [<span class="string">'danceability'</span>, <span class="string">'energy'</span>, <span class="string">'loudness'</span>, <span class="string">'speechiness'</span>, <span class="string">'acousticness'</span>, <span class="string">'instrumentalness'</span>]</span><br><span class="line"></span><br><span class="line">    <span class="keyword">for</span> i <span class="keyword">in</span> artists:</span><br><span class="line">        <span class="keyword">for</span> j <span class="keyword">in</span> artists:</span><br><span class="line">            dist = 0</span><br><span class="line">            <span class="keyword">for</span> k <span class="keyword">in</span> metrics:</span><br><span class="line">                x = <span class="built_in">float</span>(i[k])</span><br><span class="line">                x_norm = normalize(x, <span class="built_in">float</span>(avgs[k+<span class="string">'_min'</span>]), <span class="built_in">float</span>(avgs[k+<span class="string">'_max'</span>]))</span><br><span class="line">                y = <span class="built_in">float</span>(j[k])</span><br><span class="line">                y_norm = normalize(y, <span class="built_in">float</span>(avgs[k+<span class="string">'_min'</span>]), <span class="built_in">float</span>(avgs[k+<span class="string">'_max'</span>]))</span><br><span class="line">                dist += (x_norm-y_norm)**2</span><br><span class="line"></span><br><span class="line">            dist = math.sqrt(dist) <span class="comment">## euclidean distance</span></span><br><span class="line"></span><br><span class="line">            data = &#123;</span><br><span class="line">                <span class="string">'artist_id'</span>: i[<span class="string">'artist_id'</span>],</span><br><span class="line">                <span class="string">'y_artist'</span>: j[<span class="string">'artist_id'</span>],</span><br><span class="line">                <span class="string">'distance'</span>: dist</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            insert_row(cursor, data, <span class="string">'related_artists'</span>)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    conn.commit()</span><br><span class="line">    cursor.close()</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">def normalize(x, x_min, x_max):</span><br><span class="line"></span><br><span class="line">    normalized = (x-x_min) / (x_max-x_min)</span><br><span class="line"></span><br><span class="line">    <span class="built_in">return</span> normalized</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">def query_athena(query, athena):</span><br><span class="line">    response = athena.start_query_execution(</span><br><span class="line">        QueryString=query,</span><br><span class="line">        QueryExecutionContext=&#123;</span><br><span class="line">            <span class="string">'Database'</span>: <span class="string">'default'</span></span><br><span class="line">        &#125;,</span><br><span class="line">        ResultConfiguration=&#123;</span><br><span class="line">            <span class="string">'OutputLocation'</span>: <span class="string">"s3://spotify-chatbot-project/athena-panomix-tables/"</span>,</span><br><span class="line">            <span class="string">'EncryptionConfiguration'</span>: &#123;</span><br><span class="line">                <span class="string">'EncryptionOption'</span>: <span class="string">'SSE_S3'</span></span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    )</span><br><span class="line"></span><br><span class="line">    <span class="built_in">return</span> response</span><br><span class="line"></span><br><span class="line"><span class="comment"># 아래와 같이 Athena API는 response를 받았다고 해서 결과를 보여주는 것이 아니라 실행을 시킨 후에</span></span><br><span class="line"><span class="comment"># 해당 query id를 통해 결과를 가져오는 형식으로 이루어져 있다.</span></span><br><span class="line">def get_query_result(query_id, athena):</span><br><span class="line"></span><br><span class="line">    response = athena.get_query_execution(</span><br><span class="line">        QueryExecutionId=str(query_id)</span><br><span class="line">    )</span><br><span class="line">    <span class="keyword">while</span> response[<span class="string">'QueryExecution'</span>][<span class="string">'Status'</span>][<span class="string">'State'</span>] != <span class="string">'SUCCEEDED'</span>:</span><br><span class="line">        <span class="keyword">if</span> response[<span class="string">'QueryExecution'</span>][<span class="string">'Status'</span>][<span class="string">'State'</span>] == <span class="string">'FAILED'</span>:</span><br><span class="line">            logging.error(<span class="string">'QUERY FAILED'</span>)</span><br><span class="line">            <span class="built_in">break</span></span><br><span class="line">        time.sleep(5)</span><br><span class="line">        response = athena.get_query_execution(</span><br><span class="line">            QueryExecutionId=str(query_id)</span><br><span class="line">        )</span><br><span class="line">    <span class="comment"># 중요한 점은 MaxResults가 1000이 Max라는 점이다.</span></span><br><span class="line">    response = athena.get_query_results(</span><br><span class="line">        QueryExecutionId=str(query_id)</span><br><span class="line">    )</span><br><span class="line"></span><br><span class="line">    <span class="built_in">return</span> response</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">def process_data(results):</span><br><span class="line"></span><br><span class="line">    columns = [col[<span class="string">'Label'</span>] <span class="keyword">for</span> col <span class="keyword">in</span> results[<span class="string">'ResultSet'</span>][<span class="string">'ResultSetMetadata'</span>][<span class="string">'ColumnInfo'</span>]]</span><br><span class="line"></span><br><span class="line">    listed_results = []</span><br><span class="line">    <span class="keyword">for</span> res <span class="keyword">in</span> results[<span class="string">'ResultSet'</span>][<span class="string">'Rows'</span>][1:]:</span><br><span class="line">        values = []</span><br><span class="line">        <span class="keyword">for</span> field <span class="keyword">in</span> res[<span class="string">'Data'</span>]:</span><br><span class="line">            try:</span><br><span class="line">                values.append(list(field.values())[0])</span><br><span class="line">            except:</span><br><span class="line">                values.append(list(<span class="string">' '</span>))</span><br><span class="line">        listed_results.append(dict(zip(columns, values)))</span><br><span class="line"></span><br><span class="line">    <span class="built_in">return</span> listed_results</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">def insert_row(cursor, data, table):</span><br><span class="line"></span><br><span class="line">    placeholders = <span class="string">', '</span>.join([<span class="string">'%s'</span>] * len(data))</span><br><span class="line">    columns = <span class="string">', '</span>.join(data.keys())</span><br><span class="line">    key_placeholders = <span class="string">', '</span>.join([<span class="string">'&#123;0&#125;=%s'</span>.format(k) <span class="keyword">for</span> k <span class="keyword">in</span> data.keys()])</span><br><span class="line">    sql = <span class="string">"INSERT INTO %s ( %s ) VALUES ( %s ) ON DUPLICATE KEY UPDATE %s"</span> % (table, columns, placeholders, key_placeholders)</span><br><span class="line">    cursor.execute(sql, list(data.values())*2)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> __name__==<span class="string">'__main__'</span>:</span><br><span class="line">    main()</span><br></pre></td></tr></table></figure>
<ul>
<li>위의 파일을 실행시켜보자. 위의 python script 파일이 존재하는 path로 이동하여 아래 명령문을 실행시키면 실행에 완료될때까지 걸린 시간 또한 알 수 있다.</li>
</ul>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">time python3 data_modeling.py</span><br><span class="line"></span><br><span class="line">real	28m11.013s</span><br><span class="line">user	1m36.141s</span><br><span class="line">sys	0m24.518s</span><br></pre></td></tr></table></figure>
<ul>
<li>이제 MySQL에 접속해서 데이터가 제대로 insert 됬는지 확인해 보자.</li>
</ul>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line">SELECT * FROM related_artists LIMIT 20;</span><br><span class="line"></span><br><span class="line"><span class="comment"># 결과</span></span><br><span class="line">+------------------------+------------------------+-----------+</span><br><span class="line">| artist_id              | y_artist               | distance  |</span><br><span class="line">+------------------------+------------------------+-----------+</span><br><span class="line">| 00FQb4jTyendYWaN8pK0wa | 00FQb4jTyendYWaN8pK0wa |         0 |</span><br><span class="line">| 00FQb4jTyendYWaN8pK0wa | 01C9OoXDvCKkGcf735Tcfo |  0.366558 |</span><br><span class="line">| 00FQb4jTyendYWaN8pK0wa | 02rd0anEWfMtF7iMku9uor |  0.327869 |</span><br><span class="line">| 00FQb4jTyendYWaN8pK0wa | 02uYdhMhCgdB49hZlYRm9o |  0.595705 |</span><br><span class="line">| 00FQb4jTyendYWaN8pK0wa | 03r4iKL2g2442PT9n2UKsx |  0.632109 |</span><br><span class="line">| 00FQb4jTyendYWaN8pK0wa | 03YhcM6fxypfwckPCQV8pQ |  0.812604 |</span><br><span class="line">| 00FQb4jTyendYWaN8pK0wa | 04gDigrS5kc9YWfZHwBETP |  0.498764 |</span><br><span class="line">| 00FQb4jTyendYWaN8pK0wa | 04tBaW21jyUfeP5iqiKBVq |  0.322017 |</span><br><span class="line">| 00FQb4jTyendYWaN8pK0wa | 0543y7yrvny4KymoaneT4W |  0.365608 |</span><br><span class="line">| 00FQb4jTyendYWaN8pK0wa | 05E3NBxNMdnrPtxF9oraJm |  0.958604 |</span><br><span class="line">| 00FQb4jTyendYWaN8pK0wa | 06HL4z0CvFAxyc27GXpf02 |  0.483454 |</span><br><span class="line">| 00FQb4jTyendYWaN8pK0wa | 06nevPmNVfWUXyZkccahL8 | 0.0592581 |</span><br><span class="line">| 00FQb4jTyendYWaN8pK0wa | 06nsZ3qSOYZ2hPVIMcr1IN |   0.39567 |</span><br><span class="line">| 00FQb4jTyendYWaN8pK0wa | 085pc2PYOi8bGKj0PNjekA |  0.608243 |</span><br><span class="line">| 00FQb4jTyendYWaN8pK0wa | 08avsqaGIlK2x3i2Cu7rKH |  0.328059 |</span><br><span class="line">| 00FQb4jTyendYWaN8pK0wa | 09C0xjtosNAIXP36wTnWxd |  0.210568 |</span><br><span class="line">| 00FQb4jTyendYWaN8pK0wa | 0BvkDsjIUla7X0k6CSWh1I |  0.606556 |</span><br><span class="line">| 00FQb4jTyendYWaN8pK0wa | 0bvRYuXRvd14RYEE7c0PRW |  0.670187 |</span><br><span class="line">| 00FQb4jTyendYWaN8pK0wa | 0C0XlULifJtAgn6ZNCW2eu |   0.70478 |</span><br><span class="line">| 00FQb4jTyendYWaN8pK0wa | 0cc6vw3VN8YlIcvr1v7tBL |  0.716507 |</span><br><span class="line">+------------------------+------------------------+-----------+</span><br><span class="line">20 rows <span class="keyword">in</span> <span class="built_in">set</span> (0.01 sec)</span><br></pre></td></tr></table></figure>
<ul>
<li>JOIN을 통해 각각 이름을 볼수있게 해주면서 가장 distance가 작은 즉 유사성이 큰 데이터 순서로 보여주길 원해 아래와 같은 query를 작성하여 실행시켰다. 그 결과, audio_features로만 모델링을 했음에도 비슷한 장르의 아티스트가 묶여있음을 확인할 수 있다.</li>
</ul>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line">SELECT p1.name, p2.name, p1.url, p2.url, p2.distance FROM artists p1 JOIN (SELECT t1.name, t1.url, t2.y_artist, t2.distance FROM artists t1 JOIN related_artists t2 ON t2.artist_id = t1.id) p2 ON p2.y_artist=p1.id WHERE distance != 0 ORDER BY p2.distance ASC LIMIT 20;</span><br><span class="line"></span><br><span class="line">+-------------------------------+-------------------------------+--------------------------------------------------------+--------------------------------------------------------+-----------+</span><br><span class="line">| name                          | name                          | url                                                    | url                                                    | distance  |</span><br><span class="line">+-------------------------------+-------------------------------+--------------------------------------------------------+--------------------------------------------------------+-----------+</span><br><span class="line">| Four Tops                     | Alan Jackson                  | https://open.spotify.com/artist/7fIvjotigTGWqjIz6EP1i4 | https://open.spotify.com/artist/4mxWe1mtYIYfP040G38yvS | 0.0241995 |</span><br><span class="line">| Alan Jackson                  | Four Tops                     | https://open.spotify.com/artist/4mxWe1mtYIYfP040G38yvS | https://open.spotify.com/artist/7fIvjotigTGWqjIz6EP1i4 | 0.0241995 |</span><br><span class="line">| Martha Reeves &amp; The Vandellas | Jimmy Ruffin                  | https://open.spotify.com/artist/1Pe5hlKMCTULjosqZ6KanP | https://open.spotify.com/artist/0hF0PwB04hnXfYMiZWfJzy | 0.0258624 |</span><br><span class="line">| Jimmy Ruffin                  | Martha Reeves &amp; The Vandellas | https://open.spotify.com/artist/0hF0PwB04hnXfYMiZWfJzy | https://open.spotify.com/artist/1Pe5hlKMCTULjosqZ6KanP | 0.0258624 |</span><br><span class="line">| George Harrison               | Martha Reeves &amp; The Vandellas | https://open.spotify.com/artist/7FIoB5PHdrMZVC3q2HE5MS | https://open.spotify.com/artist/1Pe5hlKMCTULjosqZ6KanP | 0.0272287 |</span><br><span class="line">| Martha Reeves &amp; The Vandellas | George Harrison               | https://open.spotify.com/artist/1Pe5hlKMCTULjosqZ6KanP | https://open.spotify.com/artist/7FIoB5PHdrMZVC3q2HE5MS | 0.0272287 |</span><br><span class="line">| Nik Kershaw                   | Elton John                    | https://open.spotify.com/artist/7kCL98rPFsNKjAHDmWrMac | https://open.spotify.com/artist/3PhoLpVuITZKcymswpck5b | 0.0272474 |</span><br><span class="line">| Elton John                    | Nik Kershaw                   | https://open.spotify.com/artist/3PhoLpVuITZKcymswpck5b | https://open.spotify.com/artist/7kCL98rPFsNKjAHDmWrMac | 0.0272474 |</span><br><span class="line">| Tammi Terrell                 | Kim Carnes                    | https://open.spotify.com/artist/75jNCko3SnEMI5gwGqrbb8 | https://open.spotify.com/artist/5PN2aHIvLEM98XIorsPMhE | 0.0279891 |</span><br><span class="line">| Kim Carnes                    | Tammi Terrell                 | https://open.spotify.com/artist/5PN2aHIvLEM98XIorsPMhE | https://open.spotify.com/artist/75jNCko3SnEMI5gwGqrbb8 | 0.0279891 |</span><br><span class="line">| Roger Daltrey                 | Arcade Fire                   | https://open.spotify.com/artist/5odf7hjI7hyvAw66tmxhGF | https://open.spotify.com/artist/3kjuyTCjPG1WMFCiyc5IuB | 0.0291541 |</span><br><span class="line">| Arcade Fire                   | Roger Daltrey                 | https://open.spotify.com/artist/3kjuyTCjPG1WMFCiyc5IuB | https://open.spotify.com/artist/5odf7hjI7hyvAw66tmxhGF | 0.0291541 |</span><br><span class="line">| Billy Fury                    | Otis Redding                  | https://open.spotify.com/artist/7rtLZcKWGV4eaZsBwSKimf | https://open.spotify.com/artist/60df5JBRRPcnSpsIMxxwQm | 0.0292248 |</span><br><span class="line">| Otis Redding                  | Billy Fury                    | https://open.spotify.com/artist/60df5JBRRPcnSpsIMxxwQm | https://open.spotify.com/artist/7rtLZcKWGV4eaZsBwSKimf | 0.0292248 |</span><br><span class="line">| Katy Perry                    | John Fogerty                  | https://open.spotify.com/artist/6jJ0s89eD6GaHleKKya26X | https://open.spotify.com/artist/5ujCegv1BRbEPTCwQqFk6t | 0.0302168 |</span><br><span class="line">| John Fogerty                  | Katy Perry                    | https://open.spotify.com/artist/5ujCegv1BRbEPTCwQqFk6t | https://open.spotify.com/artist/6jJ0s89eD6GaHleKKya26X | 0.0302168 |</span><br><span class="line">| Dierks Bentley                | The Cadillac Three            | https://open.spotify.com/artist/7x8nK0m0cP2ksQf0mjWdPS | https://open.spotify.com/artist/1nivFfWu6oXBFDNyVfFU5x | 0.0313435 |</span><br><span class="line">| The Cadillac Three            | Dierks Bentley                | https://open.spotify.com/artist/1nivFfWu6oXBFDNyVfFU5x | https://open.spotify.com/artist/7x8nK0m0cP2ksQf0mjWdPS | 0.0313435 |</span><br><span class="line">| Sheryl Crow                   | Phil Collins                  | https://open.spotify.com/artist/4TKTii6gnOnUXQHyuo9JaD | https://open.spotify.com/artist/4lxfqrEsLX6N1N4OCSkILp | 0.0317203 |</span><br><span class="line">| Phil Collins                  | Sheryl Crow                   | https://open.spotify.com/artist/4lxfqrEsLX6N1N4OCSkILp | https://open.spotify.com/artist/4TKTii6gnOnUXQHyuo9JaD | 0.0317203 |</span><br><span class="line">+-------------------------------+-------------------------------+--------------------------------------------------------+--------------------------------------------------------+-----------+</span><br><span class="line">20 rows <span class="keyword">in</span> <span class="built_in">set</span> (1.18 sec)</span><br></pre></td></tr></table></figure>
<ul>
<li>이제 Facebook messenger API를 통해 챗봇을 서비스를 만들어 볼 것이다. 아래 그림과 같이 구글에서 Facebook messenger API를 검색하여 페이지로 접속한다.</li>
</ul>
<p><img src="/image/search_Facebook_messenger_API.png" alt="Facebook messenger API 검색"></p>
<ul>
<li>Facebook messenger API 웹페이지를 접속하면 아래 그림처럼 보이며, 그에 대한 작동원리에 대한 설명은 Introduction의 learn more를 클릭하면 두번째 그림과 같이 작동원리를 보여준다. 간단히 말하자면, User가 Facebook messenger API를 통해 질의하면 그 정보를 Business Server에 보내서 해당 질문에 따른 답변을 가져와 보여주는 형식이다.</li>
</ul>
<p><img src="/image/introduction_click_facebook_messenger_api.png" alt="Facebook messenger API 웹페이지"></p>
<p><img src="/image/Facebook_messenger_plattform_principal.png" alt="Facebook messenger API 작동방식"></p>
<ul>
<li>Facebook messenger API를 통해서는 다양한 방식의 답변을 제공할 수 있다. 이미 만들어져있는 UI/UX 템플릿들이 존재하기 때문에 원하는 형식에 맞춰 다양하게 서비스를 제공할 수 있다.</li>
</ul>
<p><img src="/image/Quick_answer_Facebook_messenger_api.png" alt="FaceBook messenger API의 Quick Answer"></p>
<p><img src="/image/Facebook_API_Messenge_template.png" alt="Facebook messenger의 message 템플릿"></p>
<ul>
<li><code>Facebook messenger API를 사용하기 위해서는 가장 먼저 페이지가 만들어져 있어야 한다.</code> 아래와 같이 새로운 페이지를 만들거나 이미 만들어져 있는 자신의 페이지를 먼저 등록시킨다.</li>
</ul>
<p><img src="/image/create_page_facebook_messenger_api_01.png" alt="페이지 생성 - 01"></p>
<p><img src="/image/create_page_facebook_messenger_api_02.png" alt="페이지 생성 - 02"></p>
<p><img src="/image/create_page_facebook_messenger_api_03.png" alt="페이지 생성 - 03"></p>
<p><img src="/image/create_page_facebook_messenger_api_04.png" alt="페이지 생성 - 04"></p>
<p><img src="/image/create_page_facebook_messenger_api_05.png" alt="페이지 생성 - 05"></p>
<ul>
<li>Lambda를 통해서 AWS와 Facebook messenger API를 연결해 볼 것이다. Lambda를 사용하는 이유는 지난번에 언급했던 것과 같이 EC2와 같이 서버를 항상 띄어놓고 정해진 resource를 통해 서비스를 관리하면 늘어나거나 줄어드는 User에 대해서 유연하게 처리하기 힘들기 때문이다. Lambda는 예를 들어 기하급수적으로 User가 늘더라도 그에따라 병렬적으로 작업하기 때문에 Traffic의 크기에 크게 영향을 받지 않는다. 반대로 EC2의 경우에는 해당 Traffic이 증가함에 따라 여러가지 장치를 구현해 놓아야한다. AWS에 로그인한 후 Lambda를 들어가서, 아래 그림과 같이 새로운 Lambda Function을 생성해 준다.</li>
</ul>
<p><img src="/image/new_create_lambda_function_aws_01.png" alt="Facebook messenger API를 사용하기 위한 Lambda Function 생성 - 01"></p>
<p><img src="/image/new_create_lambda_function_aws_02.png" alt="Facebook messenger API를 사용하기 위한 Lambda Function 생성 - 02"></p>
<p><img src="/image/new_create_lambda_function_aws_03.png" alt="Facebook messenger API를 사용하기 위한 Lambda Function 생성 - 03"></p>
<p><img src="/image/new_create_lambda_function_aws_04.png" alt="Facebook messenger API를 사용하기 위한 Lambda Function 생성 - 04"></p>
<ul>
<li>이제 위에서 만든 Lambda Function과 Facebook messenger API를 연결하기 위해서 AWS에서 API 관리 및 설정을 담당하는 API Gateway 페이지로 이동해서 새롭게 API Gate를 만들 것이다.</li>
</ul>
<p><img src="/image/AWS_api_gate_service.png" alt="AWS API Gateway service"></p>
<p><img src="/image/Amazon_API_Gateway.png" alt="AWS API Gateway 생성 - 01"></p>
<ul>
<li>필자는 REST API 방식으로 생성할 것이기 때문에 아래와 같이 설정하였으며, API이름도 설정해 주었다.</li>
</ul>
<p><img src="/image/Amazon_API_Gateway_creation_01.png" alt="AWS API Gateway 생성 - 02"></p>
<ul>
<li>그 다음은 Crawling할 때 한번씩 접해봤을 법한 GET, POST Method를 만들어 주는 과정을 거친다. 먼저 GET은 Integration type을 Lambda Function으로 설정해 주고, Lambda Function은 방금 만들어놓은 것을 사용할 것이다. 이렇게 설정한 뒤에 Integration Request 탭으로 이동하여 Mapping Templates의 Request body passthrough 아래와같이 설정하며, <code>mapping Templates에 application/json을 추가</code>해준다. Generate template을 Method Request passthrough로 설정한 후 최종적으로 save를 하여 GET method의 설정을 마친다. 필자가 사용할 서비스에서는 POST method는 Facebook API에 데이터를 주는 역할 밖에 없기 때문에 크게 설정할 것이 없다.</li>
</ul>
<p><img src="/image/Amazon_API_Gateway_creation_02.png" alt="AWS API Gateway 생성 - 03"></p>
<p><img src="/image/Amazon_API_Gateway_creation_03.png" alt="AWS API Gateway 생성 - 04"></p>
<p><img src="/image/Amazon_API_Gateway_creation_04.png" alt="AWS API Gateway 생성 - 05"></p>
<p><img src="/image/Amazon_API_Gateway_creation_05.png" alt="AWS API Gateway 생성 - 06"></p>
<p><img src="/image/Amazon_API_Gateway_creation_06.png" alt="AWS API Gateway 생성 - 07"></p>
<p><img src="/image/Amazon_API_Gateway_creation_07.png" alt="AWS API Gateway 생성 - 08"></p>
<p><img src="/image/Amazon_API_Gateway_creation_08.png" alt="AWS API Gateway 생성 - 09"></p>
<ul>
<li>GET, POST method를 다 설정했다면, 사용하기 위해서는 배포를 해야 할 것이다. 아래 그림과 같이 action버튼을 눌러 deploy api를 선택하여 stage를 새롭게 만들어주며, 이름을 설정한다.</li>
</ul>
<p><img src="/image/Action_deploy_API_AWS.png" alt="API Gateway 배포 - 01"></p>
<p><img src="/image/deplot_api_stage_name_AWS.png" alt="API Gateway 배포 - 02"></p>
<ul>
<li>deploy를 다 완료하게 되면, 아래 그림과 같은 화면이 나타날 것이다. 그 중 아래 빨간색 상자 안에 있는 invoke URL은 우리가 Facebook에 연결해 줄 endpoint 역할을 한다. 추후에 invoke URL 주소를 복사한 후에 아래 그림에서와 같이 Facebook에서 만들어 놓은 app의 콜백 url 추가를 눌러 추가해 줄 것이다.</li>
</ul>
<p><img src="/iamge/callback_ural_adding.png" alt="Facebook messenger API webhook url 추가"></p>
<ul>
<li>위의 그림 처럼 webhook url을 추가 해주려면 Lambda Function을 만들어 주어야 하는데 먼저 아래 그림에서와 토큰을 생성해서 복사한 후 Lambda Function을 아래 그림과 같이 작성해 준뒤에 webhook url을 추가해 줄 수 있다. 참고로 페이지 토큰은 Facebook app에서 page token을 생성하여 해당 값을 적어주고, verify token은 임으로 지정해주면 된다.</li>
</ul>
<p><img src="/image/page_token_access_create.png" alt="페이지 토큰 생성 - 01"></p>
<p><img src="/image/page_token_creation.png" alt="페이지 토큰 생성 - 02"></p>
<ul>
<li>아래와 같이 Lambda Function을 수정하는 이유는 <a href="https://developers.facebook.com/docs/messenger-platform/webhook#setup" target="_blank" rel="noopener">Facebook의 Webhook 사용법</a>을 살펴보면 알 수 있다.</li>
</ul>
<p><img src="/image/modify_lambda_Function_for_webhook_url.png" alt="webhook url 추가를 위한 Lambda Function 수정"></p>
<ul>
<li>위에서 지정한 verify token과 아래 그림에서 처럼 API Gateway를 클릭하여 이전에 invoke URL의 주소를 복사하여 아래 그림과 같이 webhook url을 추가해준다. 이렇게 하면 connection은 완료한 상태이다.</li>
</ul>
<p><img src="/image/API_Gateway_invoke_url.png" alt="invoke URL"></p>
<p><img src="/image/callback_url_adding_api.png" alt="callback URL 추가"></p>
<ul>
<li>이제 본격적으로 챗봇을 구현하기 위해 Lambda Function의 else 밑의 부분을 수정해 볼 것이다. 먼저 이전과 마찬가지로 Lambda Function은 S3에 올려 그 파일을 사용하기 위해 requirements.txt와 shell script를 포함하는 하나의 파일로 만들어 준다. 또한, AWS에서 S3에 새로운 bucket을 생성해준다. 필자는 아래와 같이 spotify-chat-bot이라는 이름으로 새롭게 bucket을 만들어 주었다.</li>
</ul>
<p><img src="/image/new_S3_bucket_creation_for_lambda_function.png" alt="새로운 S3 bucket 생성"></p>
<ul>
<li><p>전체적인 구조는 아래와 같다.</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">chatbot</span><br><span class="line">├── deploy.sh</span><br><span class="line">├── lambda_handler.py</span><br><span class="line">└── requirements.txt</span><br></pre></td></tr></table></figure>
</li>
<li><p>deploy.sh</p>
</li>
</ul>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#!/bin/bash</span></span><br><span class="line">rm -rf ./libs</span><br><span class="line">pip install -r requirements.txt -t ./libs</span><br><span class="line"></span><br><span class="line">rm *.zip</span><br><span class="line">zip spotify.zip -r *</span><br><span class="line"></span><br><span class="line">aws s3 rm s3://spotify-chat-bot/spotify.zip</span><br><span class="line">aws s3 cp ./spotify.zip s3://spotify-chat-bot/spotify.zip</span><br><span class="line">aws lambda update-function-code --<span class="keyword">function</span>-name spotify-lambda --s3-bucket spotify-chat-bot --s3-key spotify.zip</span><br></pre></td></tr></table></figure>
<ul>
<li><p>위와 같이 작성했다면 먼저 deploy.sh의 파일 권한을 바꿔준다. 모든 사용자(a)의 실행(x) 권한 추가(+)하여 준다.</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">chmod +x deploy.sh</span><br></pre></td></tr></table></figure>
</li>
<li><p>requirements.txt</p>
</li>
</ul>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">requests</span><br><span class="line">pymysql</span><br></pre></td></tr></table></figure>
<ul>
<li>lambda_hendler.py</li>
</ul>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># -*- coding: utf-8 -*-</span></span><br><span class="line">import sys</span><br><span class="line">sys.path.append(<span class="string">'./libs'</span>)</span><br><span class="line">import logging</span><br><span class="line">import requests</span><br><span class="line">import pymysql</span><br><span class="line">import fb_bot</span><br><span class="line">import json</span><br><span class="line">import base64</span><br><span class="line">import boto3</span><br><span class="line"></span><br><span class="line">logger = logging.getLogger()</span><br><span class="line">logger.setLevel(logging.INFO)</span><br><span class="line"></span><br><span class="line">PAGE_TOKEN = <span class="string">"your page token"</span></span><br><span class="line">VERIFY_TOKEN = <span class="string">"your verify code"</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">def lambda_handler(event, context):</span><br><span class="line"></span><br><span class="line">    <span class="comment"># event['params'] only exists for HTTPS GET</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> <span class="string">'params'</span> <span class="keyword">in</span> event.keys():</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> event[<span class="string">'params'</span>][<span class="string">'querystring'</span>][<span class="string">'hub.verify_token'</span>] == VERIFY_TOKEN:</span><br><span class="line">            <span class="built_in">return</span> int(event[<span class="string">'params'</span>][<span class="string">'querystring'</span>][<span class="string">'hub.challenge'</span>])</span><br><span class="line">        <span class="keyword">else</span>:</span><br><span class="line">            logging.error(<span class="string">'wrong validation token'</span>)</span><br><span class="line">            raise SystemExit</span><br><span class="line">    <span class="keyword">else</span>:</span><br><span class="line">        logger.info(event)</span><br></pre></td></tr></table></figure>
<ul>
<li>위와 같이 작성한 상태한 후 해당 파일이 존재하는 path에서 아래 shell script를 작동시킨다.</li>
</ul>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">./deploy.sh</span><br></pre></td></tr></table></figure>
<ul>
<li>AWS S3에서 해당 bucket을 확인해 보면 아래와 같이 spotify.zip 파일이 존재함을 확인할 수 있다.</li>
</ul>
<p><img src="/image/bucket_check_adding_file.png" alt="bucket 업로드 확인"></p>
<ul>
<li>다시 AWS Lambda Function으로 돌아가 해당 bucket과 연결을 시켜 볼 것이다.</li>
</ul>
<p><img src="/image/bucket_connect_with_Lambda.png" alt="Lambda Function에 bucket 파일 연결하기"></p>
<ul>
<li>Facebook App으로 돌아가서 아래 화면과 같이 필드를 추가해 주어야 한다.</li>
</ul>
<p><img src="/image/feed_add_facebook_api.png" alt="Facebook messenger API 필드 추가 - 01"></p>
<p><img src="/image/feed_add_facebook_api_01.png" alt="Facebook messenger API 필드 추가 - 02"></p>
<ul>
<li>이제 webhook으로 연결해 놓은 페이지로 접속하여 아래와 같이 버튼을 만들어 놓는다. 그 이유는 Lambda Function의 나머지 부분을 작성하기 위해서는 어떻게 event 구조가 구성되어져 있는지 확인해야 하기 때문이다.</li>
</ul>
<p><img src="/image/webhook_page_add_button_01.png" alt="webhook 페이지 버튼 추가 - 01"></p>
<p><img src="/image/webhook_page_add_button_02.png" alt="webhook 페이지 버튼 추가 - 02"></p>
<p><img src="/image/webhook_page_add_button_03.png" alt="webhook 페이지 버튼 추가 - 03"></p>
<ul>
<li>이제 AWS Lambda Function을 통해 어떻게 message가 들어오는지 확인하기 위해 아래 그림과 같이 page에서 버튼 테스트를 진행하고, 메세지는 간단하게 hello를 입력해보았다.</li>
</ul>
<p><img src="/image/button_test_01.png" alt="페이지 버튼 테스트 - 01"></p>
<p><img src="/image/button_test_02.png" alt="페이지 버튼 테스트 - 02"></p>
<ul>
<li>AWS CloudWatch에서 log를 살펴보면, 아래 그림과 같이 받아오는 것을 확인 할 수 있다. 아래 빨간색 상자안의 key 값 중 recipient는 해당 페이지의 id이며, sender의 id는 Facebook User의 id이다. 고유의 값은 아니고 각 페이지에 각 User에 대한 id이므로 동일한 User가 다른 페이지에서 요청을 했다면, 다른 id를 갖는다.</li>
</ul>
<p><img src="/image/button_test_03.png" alt="페이지 버튼 테스트 - 03"></p>
<ul>
<li>app을 관리할 수 있는 python script 파일을 fb_bot.py라는 이름으로 작성해 주었다. 이 파일 또한 위의 lambda function내에 존재할 수 있도록 path를 잡아주어야 한다. Facebook app은 <a href="https://developers.facebook.com/docs/graph-api/using-graph-api" target="_blank" rel="noopener">graph Facebook API</a>를 통해서 control할 수 있다. 아래 패키지 중 <a href="https://python.flowdas.com/library/enum.html" target="_blank" rel="noopener">Enum</a>은 고유한 이름 집합과 값을 정의하는 데 사용할 수 있는 네 가지 열거형 클래스를 정의하는데 사용되어 진다. 아래함수에서 for문을 통해 NotificationType을 작동시킨다면, NotificationType.REGULAR, NotificationType.SILENT_PUSH, NotificationType.no_push 식으로 값이 프린트 된다. 아래 탬플릿에 맞는 형식은 <a href="https://developers.facebook.com/docs/messenger-platform/send-messages/templates" target="_blank" rel="noopener">Facebook messenger API</a>에서 확인할 수 있다.</li>
</ul>
<p><img src="/image/send_API_messenger.png" alt="fb_bot.py에 사용된 템플릿 - 01"></p>
<ul>
<li>fb_bot.py</li>
</ul>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br><span class="line">200</span><br><span class="line">201</span><br><span class="line">202</span><br><span class="line">203</span><br><span class="line">204</span><br><span class="line">205</span><br><span class="line">206</span><br><span class="line">207</span><br><span class="line">208</span><br><span class="line">209</span><br><span class="line">210</span><br><span class="line">211</span><br><span class="line">212</span><br><span class="line">213</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#!/usr/bin/env python</span></span><br><span class="line"></span><br><span class="line">import sys</span><br><span class="line">sys.path.append(<span class="string">"./libs"</span>)</span><br><span class="line">import os</span><br><span class="line">import requests</span><br><span class="line">import base64</span><br><span class="line">import json</span><br><span class="line">import logging</span><br><span class="line">from enum import Enum</span><br><span class="line"></span><br><span class="line">DEFAULT_API_VERSION = 6.0</span><br><span class="line"></span><br><span class="line"><span class="comment">## messaging types: "RESPONSE", "UPDATE", "MESSAGE_TAG"</span></span><br><span class="line"></span><br><span class="line">class NotificationType(Enum):</span><br><span class="line">    regular = <span class="string">"REGULAR"</span></span><br><span class="line">    silent_push = <span class="string">"SILENT_PUSH"</span></span><br><span class="line">    no_push = <span class="string">"no_push"</span></span><br><span class="line"></span><br><span class="line">class Bot:</span><br><span class="line"></span><br><span class="line">    def __init__(self, access_token, **kwargs):</span><br><span class="line"></span><br><span class="line">        self.access_token = access_token</span><br><span class="line">        self.api_version = kwargs.get(<span class="string">'api_version'</span>) or DEFAULT_API_VERSION</span><br><span class="line">        self.graph_url = <span class="string">'https://graph.facebook.com/v&#123;0&#125;'</span>.format(self.api_version)</span><br><span class="line"></span><br><span class="line">    @property</span><br><span class="line">    def auth_args(self):</span><br><span class="line">        <span class="keyword">if</span> not hasattr(self, <span class="string">'_auth_args'</span>):</span><br><span class="line">            auth = &#123;</span><br><span class="line">                <span class="string">'access_token'</span>: self.access_token</span><br><span class="line">            &#125;</span><br><span class="line">            self._auth_args = auth</span><br><span class="line">        <span class="built_in">return</span> self._auth_args</span><br><span class="line"></span><br><span class="line">    def send_message(self, recipient_id, payload, notification_type, messaging_type, tag):</span><br><span class="line"></span><br><span class="line">        payload[<span class="string">'recipient'</span>] = &#123;</span><br><span class="line">            <span class="string">'id'</span>: recipient_id</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="comment">#payload['notification_type'] = notification_type</span></span><br><span class="line">        payload[<span class="string">'messaging_type'</span>] = messaging_type</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> tag is not None:</span><br><span class="line">            payload[<span class="string">'tag'</span>] = tag</span><br><span class="line"></span><br><span class="line">        request_endpoint = <span class="string">'&#123;0&#125;/me/messages'</span>.format(self.graph_url)</span><br><span class="line"></span><br><span class="line">        response = requests.post(</span><br><span class="line">            request_endpoint,</span><br><span class="line">            params = self.auth_args,</span><br><span class="line">            json = payload</span><br><span class="line">        )</span><br><span class="line"></span><br><span class="line">        logging.info(payload)</span><br><span class="line">        <span class="built_in">return</span> response.json()</span><br><span class="line"></span><br><span class="line">    def send_text(self, recipient_id, text, notification_type = NotificationType.regular, messaging_type = <span class="string">'RESPONSE'</span>, tag = None):</span><br><span class="line"></span><br><span class="line">        <span class="built_in">return</span> self.send_message(</span><br><span class="line">            recipient_id,</span><br><span class="line">            &#123;</span><br><span class="line">                <span class="string">"message"</span>: &#123;</span><br><span class="line">                    <span class="string">"text"</span>: text</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;,</span><br><span class="line">            notification_type,</span><br><span class="line">            messaging_type,</span><br><span class="line">            tag</span><br><span class="line">        )</span><br><span class="line"></span><br><span class="line">    def send_quick_replies(self, recipient_id, text, quick_replies, notification_type = NotificationType.regular, messaging_type = <span class="string">'RESPONSE'</span>, tag = None):</span><br><span class="line"></span><br><span class="line">        <span class="built_in">return</span> self.send_message(</span><br><span class="line">            recipient_id,</span><br><span class="line">            &#123;</span><br><span class="line">                <span class="string">"message"</span>:&#123;</span><br><span class="line">                    <span class="string">"text"</span>: text,</span><br><span class="line">                    <span class="string">"quick_replies"</span>: quick_replies</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;,</span><br><span class="line">            notification_type,</span><br><span class="line">            messaging_type,</span><br><span class="line">            tag</span><br><span class="line">        )</span><br><span class="line"></span><br><span class="line">    def send_attachment(self, recipient_id, attachment_type, payload, notification_type = NotificationType.regular, messaging_type = <span class="string">'RESPONSE'</span>, tag = None):</span><br><span class="line"></span><br><span class="line">        <span class="built_in">return</span> self.send_message(</span><br><span class="line">            recipient_id,</span><br><span class="line">            &#123;</span><br><span class="line">                <span class="string">"message"</span>: &#123;</span><br><span class="line">                    <span class="string">"attachment"</span>:&#123;</span><br><span class="line">                        <span class="string">"type"</span>: attachment_type,</span><br><span class="line">                        <span class="string">"payload"</span>: payload</span><br><span class="line">                    &#125;</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;,</span><br><span class="line">            notification_type,</span><br><span class="line">            messaging_type,</span><br><span class="line">            tag</span><br><span class="line">        )</span><br><span class="line"></span><br><span class="line">    def send_action(self, recipient_id, action, notification_type = NotificationType.regular, messaging_type = <span class="string">'RESPONSE'</span>, tag = None):</span><br><span class="line"></span><br><span class="line">        <span class="built_in">return</span> self.send_message(</span><br><span class="line">            recipient_id,</span><br><span class="line">            &#123;</span><br><span class="line">                <span class="string">"sender_action"</span>: action</span><br><span class="line">            &#125;,</span><br><span class="line">            notification_type,</span><br><span class="line">            messaging_type,</span><br><span class="line">            tag</span><br><span class="line">        )</span><br><span class="line"></span><br><span class="line">    def whitelist_domain(self, domain_list, domain_action_type):</span><br><span class="line"></span><br><span class="line">        payload = &#123;</span><br><span class="line">            <span class="string">"setting_type"</span>: <span class="string">"domain_whitelisting"</span>,</span><br><span class="line">            <span class="string">"whitelisted_domains"</span>: domain_list,</span><br><span class="line">            <span class="string">"domain_action_type"</span>: domain_action_type</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        request_endpoint = <span class="string">'&#123;0&#125;/me/thread_settings'</span>.format(self.graph_url)</span><br><span class="line"></span><br><span class="line">        response = requests.post(</span><br><span class="line">            request_endpoint,</span><br><span class="line">            params = self.auth_args,</span><br><span class="line">            json = payload</span><br><span class="line">        )</span><br><span class="line"></span><br><span class="line">        <span class="built_in">return</span> response.json()</span><br><span class="line"></span><br><span class="line">    def set_greeting(self, template):</span><br><span class="line"></span><br><span class="line">        request_endpoint = <span class="string">'&#123;0&#125;/me/thread_settings'</span>.format(self.graph_url)</span><br><span class="line"></span><br><span class="line">        response = requests.post(</span><br><span class="line">            request_endpoint,</span><br><span class="line">            params = self.auth_args,</span><br><span class="line">            json = &#123;</span><br><span class="line">                <span class="string">"setting_type"</span>: <span class="string">"greeting"</span>,</span><br><span class="line">                <span class="string">"greeting"</span>: &#123;</span><br><span class="line">                    <span class="string">"text"</span>: template</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        )</span><br><span class="line"></span><br><span class="line">        <span class="built_in">return</span> response</span><br><span class="line"></span><br><span class="line">    def set_get_started(self, text):</span><br><span class="line"></span><br><span class="line">        request_endpoint = <span class="string">'&#123;0&#125;/me/messenger_profile'</span>.format(self.graph_url)</span><br><span class="line"></span><br><span class="line">        response = requests.post(</span><br><span class="line">            request_endpoint,</span><br><span class="line">            params = self.auth_args,</span><br><span class="line">            json = &#123;</span><br><span class="line">                <span class="string">"get_started"</span>:&#123;</span><br><span class="line">                    <span class="string">"payload"</span>: text</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        )</span><br><span class="line"></span><br><span class="line">        <span class="built_in">return</span> response</span><br><span class="line"></span><br><span class="line">    def get_get_started(self):</span><br><span class="line"></span><br><span class="line">        request_endpoint = <span class="string">'&#123;0&#125;/me/messenger_profile?fields=get_started'</span>.format(self.graph_url)</span><br><span class="line"></span><br><span class="line">        response = requests.get(</span><br><span class="line">            request_endpoint,</span><br><span class="line">            params = self.auth_args</span><br><span class="line">        )</span><br><span class="line"></span><br><span class="line">        <span class="built_in">return</span> response</span><br><span class="line"></span><br><span class="line">    def get_messenger_profile(self, field):</span><br><span class="line"></span><br><span class="line">        request_endpoint = <span class="string">'&#123;0&#125;/me/messenger_profile?fields=&#123;1&#125;'</span>.format(self.graph_url, field)</span><br><span class="line"></span><br><span class="line">        response = requests.get(</span><br><span class="line">            request_endpoint,</span><br><span class="line">            params = self.auth_args</span><br><span class="line">        )</span><br><span class="line"></span><br><span class="line">        <span class="built_in">return</span> response</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    def upload_attachment(self, url):</span><br><span class="line"></span><br><span class="line">        request_endpoint = <span class="string">'&#123;0&#125;/me/message_attachments'</span>.format(self.graph_url)</span><br><span class="line"></span><br><span class="line">        response = requests.post(</span><br><span class="line">            request_endpoint,</span><br><span class="line">            params = self.auth_args,</span><br><span class="line">            json = &#123;</span><br><span class="line">                <span class="string">"message"</span>:&#123;</span><br><span class="line">                    <span class="string">"attachment"</span>:&#123;</span><br><span class="line">                        <span class="string">"type"</span>: <span class="string">"image"</span>,</span><br><span class="line">                        <span class="string">"payload"</span>: &#123;</span><br><span class="line">                            <span class="string">"is_reusable"</span>: True,</span><br><span class="line">                            <span class="string">"url"</span>: url</span><br><span class="line">                        &#125;</span><br><span class="line">                    &#125;</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        )</span><br><span class="line"></span><br><span class="line">        <span class="built_in">return</span> response</span><br></pre></td></tr></table></figure>
<ul>
<li><p>이제 위의 fb_bot.py를 import하여 lambda_hendler.py 파일을 아래와 같이 수정해 주었다.</p>
</li>
<li><p>lambda_hendler.py</p>
</li>
</ul>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># -*- coding: utf-8 -*-</span></span><br><span class="line">import sys</span><br><span class="line">sys.path.append(<span class="string">'./libs'</span>)</span><br><span class="line">import logging</span><br><span class="line">import requests</span><br><span class="line">import pymysql</span><br><span class="line">import fb_bot</span><br><span class="line">import json</span><br><span class="line">import base64</span><br><span class="line">import boto3</span><br><span class="line"></span><br><span class="line">logger = logging.getLogger()</span><br><span class="line">logger.setLevel(logging.INFO)</span><br><span class="line"></span><br><span class="line">client_id = <span class="string">"Your Spotify ID"</span></span><br><span class="line">client_secret = <span class="string">"Your Spotify PW"</span></span><br><span class="line"></span><br><span class="line">PAGE_TOKEN = <span class="string">"Your Page Token"</span></span><br><span class="line">VERIFY_TOKEN = <span class="string">"Your verify token"</span></span><br><span class="line"></span><br><span class="line">host = <span class="string">"Your RDS End point"</span></span><br><span class="line">port = 3306</span><br><span class="line">username = <span class="string">"Your RDS ID"</span></span><br><span class="line">database = <span class="string">"Using RDS table name"</span></span><br><span class="line">password = <span class="string">"Your RDS PW"</span></span><br><span class="line"></span><br><span class="line">try:</span><br><span class="line">    conn = pymysql.connect(host, user=username, passwd=password, db=database, port=port, use_unicode=True, charset=<span class="string">'utf8'</span>)</span><br><span class="line">    cursor = conn.cursor()</span><br><span class="line">except:</span><br><span class="line">    logging.error(<span class="string">"could not connect to rds"</span>)</span><br><span class="line">    sys.exit(1)</span><br><span class="line"></span><br><span class="line">bot = fb_bot.Bot(PAGE_TOKEN)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">def lambda_handler(event, context):</span><br><span class="line"></span><br><span class="line">    <span class="comment"># event['params'] only exists for HTTPS GET</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> <span class="string">'params'</span> <span class="keyword">in</span> event.keys():</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> event[<span class="string">'params'</span>][<span class="string">'querystring'</span>][<span class="string">'hub.verify_token'</span>] == VERIFY_TOKEN:</span><br><span class="line">            <span class="built_in">return</span> int(event[<span class="string">'params'</span>][<span class="string">'querystring'</span>][<span class="string">'hub.challenge'</span>])</span><br><span class="line">        <span class="keyword">else</span>:</span><br><span class="line">            logging.error(<span class="string">'wrong validation token'</span>)</span><br><span class="line">            raise SystemExit</span><br><span class="line">    <span class="keyword">else</span>:</span><br><span class="line">        messaging = event[<span class="string">'entry'</span>][0][<span class="string">'messaging'</span>][0]</span><br><span class="line">        user_id = messaging[<span class="string">'sender'</span>][<span class="string">'id'</span>]</span><br><span class="line"></span><br><span class="line">        logger.info(messaging)</span><br><span class="line">        artist_name = messaging[<span class="string">'message'</span>][<span class="string">'text'</span>]</span><br><span class="line"></span><br><span class="line">        query = <span class="string">"SELECT image_url, url FROM artists WHERE name = '&#123;&#125;'"</span>.format(artist_name)</span><br><span class="line">        cursor.execute(query)</span><br><span class="line">        raw = cursor.fetchall()</span><br><span class="line">        <span class="comment"># raw가 0인 경우는 DB안에는 존재하지 않으므로 Spotify API에서 직접 search한다.</span></span><br><span class="line">        <span class="keyword">if</span> len(raw) == 0:</span><br><span class="line">            text = search_artist(cursor, artist_name)</span><br><span class="line">            bot.send_text(user_id, text)</span><br><span class="line">            sys.exit(0)</span><br><span class="line"></span><br><span class="line">        image_url, url = raw[0]</span><br><span class="line"></span><br><span class="line">        payload = &#123;</span><br><span class="line">            <span class="string">'template_type'</span>: <span class="string">'generic'</span>,</span><br><span class="line">            <span class="string">'elements'</span>: [</span><br><span class="line">                &#123;</span><br><span class="line">                    <span class="string">'title'</span>: <span class="string">"Artist Info: '&#123;&#125;'"</span>.format(artist_name),</span><br><span class="line">                    <span class="string">'image_url'</span>: image_url,</span><br><span class="line">                    <span class="string">'subtitle'</span>: <span class="string">'information'</span>,</span><br><span class="line">                    <span class="string">'default_action'</span>: &#123;</span><br><span class="line">                        <span class="string">'type'</span>: <span class="string">'web_url'</span>,</span><br><span class="line">                        <span class="string">'url'</span>: url,</span><br><span class="line">                        <span class="string">'webview_height_ratio'</span>: <span class="string">'full'</span></span><br><span class="line">                    &#125;</span><br><span class="line">                &#125;</span><br><span class="line">            ]</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        bot.send_attachment(user_id, <span class="string">"template"</span>, payload)</span><br><span class="line"></span><br><span class="line">        query = <span class="string">"SELECT t2.genre FROM artists t1 JOIN artist_genres t2 ON t2.artist_id = t1.id WHERE t1.name = '&#123;&#125;'"</span>.format(artist_name)</span><br><span class="line"></span><br><span class="line">        cursor.execute(query)</span><br><span class="line">        genres = []</span><br><span class="line">        <span class="keyword">for</span> (genre, ) <span class="keyword">in</span> cursor.fetchall():</span><br><span class="line">            genres.append(genre)</span><br><span class="line"></span><br><span class="line">        text = <span class="string">"Here are genres of &#123;&#125;"</span>.format(artist_name)</span><br><span class="line">        bot.send_text(user_id, text)</span><br><span class="line">        bot.send_text(user_id, <span class="string">', '</span>.join(genres))</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">        <span class="comment">## 만약에 아티스트가 없을시에는 아티스트 추가</span></span><br><span class="line"></span><br><span class="line">        <span class="comment">## Spotify API hit --&gt; Artist Search</span></span><br><span class="line">        <span class="comment">## Database Upload</span></span><br><span class="line">        <span class="comment">## One second</span></span><br><span class="line">        <span class="comment">## 오타 및 아티스트가 아닐 경우</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">def get_headers(client_id, client_secret):</span><br><span class="line"></span><br><span class="line">    endpoint = <span class="string">"https://accounts.spotify.com/api/token"</span></span><br><span class="line">    encoded = base64.b64encode(<span class="string">"&#123;&#125;:&#123;&#125;"</span>.format(client_id, client_secret).encode(<span class="string">'utf-8'</span>)).decode(<span class="string">'ascii'</span>)</span><br><span class="line"></span><br><span class="line">    headers = &#123;</span><br><span class="line">        <span class="string">"Authorization"</span>: <span class="string">"Basic &#123;&#125;"</span>.format(encoded)</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    payload = &#123;</span><br><span class="line">        <span class="string">"grant_type"</span>: <span class="string">"client_credentials"</span></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    r = requests.post(endpoint, data=payload, headers=headers)</span><br><span class="line"></span><br><span class="line">    access_token = json.loads(r.text)[<span class="string">'access_token'</span>]</span><br><span class="line"></span><br><span class="line">    headers = &#123;</span><br><span class="line">        <span class="string">"Authorization"</span>: <span class="string">"Bearer &#123;&#125;"</span>.format(access_token)</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="built_in">return</span> headers</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">def insert_row(cursor, data, table):</span><br><span class="line"></span><br><span class="line">    placeholders = <span class="string">', '</span>.join([<span class="string">'%s'</span>] * len(data))</span><br><span class="line">    columns = <span class="string">', '</span>.join(data.keys())</span><br><span class="line">    key_placeholders = <span class="string">', '</span>.join([<span class="string">'&#123;0&#125;=%s'</span>.format(k) <span class="keyword">for</span> k <span class="keyword">in</span> data.keys()])</span><br><span class="line">    sql = <span class="string">"INSERT INTO %s ( %s ) VALUES ( %s ) ON DUPLICATE KEY UPDATE %s"</span> % (table, columns, placeholders, key_placeholders)</span><br><span class="line">    cursor.execute(sql, list(data.values())*2)</span><br><span class="line"></span><br><span class="line"><span class="comment"># 추가적으로 S3의 top_tracks에도 업데이트해주기 위해서 top-tracks lambda function을 실행시켜주는 함수이다.</span></span><br><span class="line"><span class="comment"># payload 부분은 lambda_handler 함수 안에서 들어오는 event에 관한 부분이다.</span></span><br><span class="line">def invoke_lambda(fxn_name, payload, invocation_type=<span class="string">'Event'</span>):</span><br><span class="line"></span><br><span class="line">    lambda_client = boto3.client(<span class="string">'lambda'</span>)</span><br><span class="line"></span><br><span class="line">    invoke_response = lambda_client.invoke(</span><br><span class="line">        FunctionName = fxn_name,</span><br><span class="line">        InvocationType = invocation_type,</span><br><span class="line">        Payload = json.dumps(payload)</span><br><span class="line">    )</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> invoke_response[<span class="string">'StatusCode'</span>] not <span class="keyword">in</span> [200, 202, 204]:</span><br><span class="line">        logging.error(<span class="string">"ERROR: Invoking lmabda function: '&#123;0&#125;' failed"</span>.format(fxn_name))</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    <span class="built_in">return</span> invoke_response</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">def search_artist(cursor, artist_name):</span><br><span class="line"></span><br><span class="line">    headers = get_headers(client_id, client_secret)</span><br><span class="line"></span><br><span class="line">    <span class="comment">## Spotify Search API</span></span><br><span class="line">    params = &#123;</span><br><span class="line">        <span class="string">"q"</span>: artist_name,</span><br><span class="line">        <span class="string">"type"</span>: <span class="string">"artist"</span>,</span><br><span class="line">        <span class="string">"limit"</span>: <span class="string">"1"</span></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    r = requests.get(<span class="string">"https://api.spotify.com/v1/search"</span>, params=params, headers=headers)</span><br><span class="line"></span><br><span class="line">    raw = json.loads(r.text)</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> raw[<span class="string">'artists'</span>][<span class="string">'items'</span>] == []:</span><br><span class="line">        <span class="built_in">return</span> <span class="string">"Could not find artist. Please Try Again!"</span></span><br><span class="line"></span><br><span class="line">    artist = &#123;&#125;</span><br><span class="line">    artist_raw = raw[<span class="string">'artists'</span>][<span class="string">'items'</span>][0]</span><br><span class="line">    <span class="keyword">if</span> artist_raw[<span class="string">'name'</span>] == params[<span class="string">'q'</span>]:</span><br><span class="line"></span><br><span class="line">        artist.update(</span><br><span class="line">            &#123;</span><br><span class="line">                <span class="string">'id'</span>: artist_raw[<span class="string">'id'</span>],</span><br><span class="line">                <span class="string">'name'</span>: artist_raw[<span class="string">'name'</span>],</span><br><span class="line">                <span class="string">'followers'</span>: artist_raw[<span class="string">'followers'</span>][<span class="string">'total'</span>],</span><br><span class="line">                <span class="string">'popularity'</span>: artist_raw[<span class="string">'popularity'</span>],</span><br><span class="line">                <span class="string">'url'</span>: artist_raw[<span class="string">'external_urls'</span>][<span class="string">'spotify'</span>],</span><br><span class="line">                <span class="string">'image_url'</span>: artist_raw[<span class="string">'images'</span>][0][<span class="string">'url'</span>]</span><br><span class="line">            &#125;</span><br><span class="line">        )</span><br><span class="line"></span><br><span class="line">        <span class="keyword">for</span> i <span class="keyword">in</span> artist_raw[<span class="string">'genres'</span>]:</span><br><span class="line">            <span class="keyword">if</span> len(artist_raw[<span class="string">'genres'</span>]) != 0:</span><br><span class="line">                insert_row(cursor, &#123;<span class="string">'artist_id'</span>: artist_raw[<span class="string">'id'</span>], <span class="string">'genre'</span>: i&#125;, <span class="string">'artist_genres'</span>)</span><br><span class="line"></span><br><span class="line">        insert_row(cursor, artist, <span class="string">'artists'</span>)</span><br><span class="line">        conn.commit()</span><br><span class="line">        r = invoke_lambda(<span class="string">'top-tracks'</span>, payload=&#123;<span class="string">'artist_id'</span>: artist_raw[<span class="string">'id'</span>]&#125;)</span><br><span class="line">        <span class="built_in">print</span>(r)</span><br><span class="line"></span><br><span class="line">        <span class="built_in">return</span> <span class="string">"We added artist. Please try again in a second!"</span></span><br><span class="line"></span><br><span class="line">    <span class="built_in">return</span> <span class="string">"Could not find artist. Please Try Again!"</span></span><br></pre></td></tr></table></figure>
<ul>
<li>위에서 다른 trigger lambda function을 참조할 수 있도록 설정해 주었기 때문에 아래와 같이 role을 다른 lambda function을 invoke 할 수 있도록 IAM 페이지에서 permission을 추가해 주어야 정상적으로 작동된다.</li>
</ul>
<p><img src="/image/IAM_page_goto.png" alt="IAM 페이지로 이동"></p>
<p><img src="/image/add_permission_for_invoke.png" alt="IAM 페이지에서 invoke를 위한 permission 추가"></p>
<ul>
<li>이제 해당 페이지의 test를 진행해 보면 아래와 같이 위에서 설정한 것 처럼 해당아티스트의 url과 장르를 보내주는 것을 확인 할 수 있다. 그림은 없지만 필자는 2PM도 검색해보았는데, 잘 검색되어 나왔다.</li>
</ul>
<p><img src="/image/BTS_find_my_chat_bot.png" alt="BTS 검색 결과"></p>
<ul>
<li>이제껏 data engineering에 관한 몇가지 기초적인 부분들을 실습해 보며, data engineer는 상황에 맞춰 resource를 사용할 수 있도록 선택과 집중을 해야 한다고 생각했다. 그러한, 상황에 맞는 선택과 집중을 위해 해당 비즈니스가 처해있는 상황과 단계를 잘 진단하고 깊게 알고있어야 할 것 같다는 생각을 하게 되는 프로젝트 였다.</li>
</ul>

        </div>
        <script async src="https://pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
<!-- 하단형 -->
<ins class="adsbygoogle"
     style="display:block"
     data-ad-client="ca-pub-4604833066889492"
     data-ad-slot="9861011486"
     data-ad-format="auto"
     data-full-width-responsive="true"></ins>
<script>
     (adsbygoogle = window.adsbygoogle || []).push({});
</script>

        <footer class="article-footer">
            


    <div class="a2a_kit a2a_default_style">
    <a class="a2a_dd" href="https://www.addtoany.com/share">Share</a>
    <span class="a2a_divider"></span>
    <a class="a2a_button_facebook"></a>
    <a class="a2a_button_twitter"></a>
    <a class="a2a_button_google_plus"></a>
    <a class="a2a_button_pinterest"></a>
    <a class="a2a_button_tumblr"></a>
</div>
<script type="text/javascript" src="//static.addtoany.com/menu/page.js"></script>
<style>
    .a2a_menu {
        border-radius: 4px;
    }
    .a2a_menu a {
        margin: 2px 0;
        font-size: 14px;
        line-height: 16px;
        border-radius: 4px;
        color: inherit !important;
        font-family: 'Microsoft Yahei';
    }
    #a2apage_dropdown {
        margin: 10px 0;
    }
    .a2a_mini_services {
        padding: 10px;
    }
    a.a2a_i,
    i.a2a_i {
        width: 122px;
        line-height: 16px;
    }
    a.a2a_i .a2a_svg,
    a.a2a_more .a2a_svg {
        width: 16px;
        height: 16px;
        line-height: 16px;
        vertical-align: top;
        background-size: 16px;
    }
    a.a2a_i {
        border: none !important;
    }
    a.a2a_menu_show_more_less {
        margin: 0;
        padding: 10px 0;
        line-height: 16px;
    }
    .a2a_mini_services:after{content:".";display:block;height:0;clear:both;visibility:hidden}
    .a2a_mini_services{*+height:1%;}
</style>


        </footer>
    </div>
    <script type="application/ld+json">
    {
        "@context": "https://schema.org",
        "@type": "BlogPosting",
        "author": {
            "@type": "Person",
            "name": "HeungBae Lee"
        },
        "headline": "data engineering (데이터 모델링 및 챗봇 만들기)",
        "image": "https://heung-bae-lee.github.io/image/Athena_similarity_table_create.png",
        "keywords": "",
        "genre": "data engineering",
        "datePublished": "2020-03-03",
        "dateCreated": "2020-03-03",
        "dateModified": "2020-03-09",
        "url": "https://heung-bae-lee.github.io/2020/03/03/data_engineering_10/",
        "description": "Spotify 데이터 유사도 모델링
모든 track을 다 유클리디안 거리를 계산해서 유사도를 측정하기에는 많은 양이기 때문에 해당 Artist의 track들의 audio feature 데이터에 대해 평균을 낸 값을 사용하여 Artist 끼리의 유사도를 계산할 것이다. 해당 유사도를 계산하기 위해 아래와 같이 먼저 RDS에 접속하여 table을 생성해 준다."
        "wordCount": 9057
    }
</script>

</article>

    <section id="comments">
    
        
    <div id="disqus_thread">
        <noscript>Please enable JavaScript to view the <a href="//disqus.com/?ref_noscript">comments powered by Disqus.</a></noscript>
    </div>

    
    </section>



                        </div>
                    </section>
                    <aside id="sidebar">
    <a class="sidebar-toggle" title="Expand Sidebar"><i class="toggle icon"></i></a>
    <div class="sidebar-top">
        <p>follow:</p>
        <ul class="social-links">
            
                
                <li>
                    <a class="social-tooltip" title="facebook" href="https://www.facebook.com/heungbae.lee" target="_blank" rel="noopener">
                        <i class="icon fa fa-facebook"></i>
                    </a>
                </li>
                
            
                
                <li>
                    <a class="social-tooltip" title="github" href="https://github.com/HEUNG-BAE-LEE" target="_blank" rel="noopener">
                        <i class="icon fa fa-github"></i>
                    </a>
                </li>
                
            
        </ul>
    </div>
    
        
<nav id="article-nav">
    
        <a href="/2020/03/19/data_structure_01/" id="article-nav-newer" class="article-nav-link-wrap">
        <strong class="article-nav-caption">newer</strong>
        <p class="article-nav-title">
        
            내가 정리하는 자료구조 00 (Node, List, Queue)
        
        </p>
        <i class="icon fa fa-chevron-right" id="icon-chevron-right"></i>
    </a>
    
    
        <a href="/2020/03/01/data_engineering_09/" id="article-nav-older" class="article-nav-link-wrap">
        <strong class="article-nav-caption">older</strong>
        <p class="article-nav-title">data engineering (데이터 파이프라인 자동화)</p>
        <i class="icon fa fa-chevron-left" id="icon-chevron-left"></i>
        </a>
    
</nav>

    
    <div class="widgets-container">
        
            
                

            
                
    <div class="widget-wrap">
        <h3 class="widget-title">recents</h3>
        <div class="widget">
            <ul id="recent-post" class="no-thumbnail">
                
                    <li>
                        
                        <div class="item-inner">
                            <p class="item-category"></p>
                            <p class="item-title"><a href="/2020/05/17/data_structure_07/" class="title">내가 정리하는 자료구조 06 - 힙(heap)</a></p>
                            <p class="item-date"><time datetime="2020-05-17T14:39:31.000Z" itemprop="datePublished">2020-05-17</time></p>
                        </div>
                    </li>
                
                    <li>
                        
                        <div class="item-inner">
                            <p class="item-category"><a class="article-category-link" href="/categories/linear-algebra/">linear algebra</a></p>
                            <p class="item-title"><a href="/2020/05/14/linear_algebra_03/" class="title">Linear combination, vector equation, Four views of matrix multiplication</a></p>
                            <p class="item-date"><time datetime="2020-05-14T06:36:03.000Z" itemprop="datePublished">2020-05-14</time></p>
                        </div>
                    </li>
                
                    <li>
                        
                        <div class="item-inner">
                            <p class="item-category"><a class="article-category-link" href="/categories/linear-algebra/">linear algebra</a></p>
                            <p class="item-title"><a href="/2020/05/13/linear_algebra_02/" class="title">선형 시스템(Linear system)</a></p>
                            <p class="item-date"><time datetime="2020-05-13T07:50:33.000Z" itemprop="datePublished">2020-05-13</time></p>
                        </div>
                    </li>
                
                    <li>
                        
                        <div class="item-inner">
                            <p class="item-category"><a class="article-category-link" href="/categories/linear-algebra/">linear algebra</a></p>
                            <p class="item-title"><a href="/2020/05/12/linear_algebra_01/" class="title">선형대수 요소(Elements in linear algebra)</a></p>
                            <p class="item-date"><time datetime="2020-05-12T13:41:59.000Z" itemprop="datePublished">2020-05-12</time></p>
                        </div>
                    </li>
                
                    <li>
                        
                        <div class="item-inner">
                            <p class="item-category"><a class="article-category-link" href="/categories/machine-learning/">machine learning</a></p>
                            <p class="item-title"><a href="/2020/05/02/machine_learning_14/" class="title">Ensemble Learning - 01</a></p>
                            <p class="item-date"><time datetime="2020-05-02T12:00:10.000Z" itemprop="datePublished">2020-05-02</time></p>
                        </div>
                    </li>
                
            </ul>
        </div>
    </div>

            
                
    <div class="widget-wrap widget-list">
        <h3 class="widget-title">categories</h3>
        <div class="widget">
            <ul class="category-list"><li class="category-list-item"><a class="category-list-link" href="/categories/Bayes/">Bayes</a><span class="category-list-count">1</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/C-C-자료구조/">C/C++/자료구조</a><span class="category-list-count">7</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/CS231n/">CS231n</a><span class="category-list-count">6</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/Front-end/">Front end</a><span class="category-list-count">4</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/Kaggle/">Kaggle</a><span class="category-list-count">1</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/NLP/">NLP</a><span class="category-list-count">14</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/Python/">Python</a><span class="category-list-count">1</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/Recommendation-System/">Recommendation System</a><span class="category-list-count">1</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/Statistics-Mathematical-Statistics/">Statistics - Mathematical Statistics</a><span class="category-list-count">1</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/crawling/">crawling</a><span class="category-list-count">5</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/data-engineering/">data engineering</a><span class="category-list-count">11</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/deep-learning/">deep learning</a><span class="category-list-count">13</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/growth-hacking/">growth hacking</a><span class="category-list-count">2</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/hexo/">hexo</a><span class="category-list-count">1</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/linear-algebra/">linear algebra</a><span class="category-list-count">4</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/machine-learning/">machine learning</a><span class="category-list-count">15</span></li></ul>
        </div>
    </div>


            
                
    <div class="widget-wrap widget-list">
        <h3 class="widget-title">archives</h3>
        <div class="widget">
            <ul class="archive-list"><li class="archive-list-item"><a class="archive-list-link" href="/archives/2020/05/">May 2020</a><span class="archive-list-count">6</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2020/04/">April 2020</a><span class="archive-list-count">13</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2020/03/">March 2020</a><span class="archive-list-count">4</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2020/02/">February 2020</a><span class="archive-list-count">11</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2020/01/">January 2020</a><span class="archive-list-count">20</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2019/12/">December 2019</a><span class="archive-list-count">14</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2019/11/">November 2019</a><span class="archive-list-count">1</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2019/09/">September 2019</a><span class="archive-list-count">2</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2019/08/">August 2019</a><span class="archive-list-count">1</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2019/07/">July 2019</a><span class="archive-list-count">9</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2019/05/">May 2019</a><span class="archive-list-count">2</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2019/03/">March 2019</a><span class="archive-list-count">2</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2019/02/">February 2019</a><span class="archive-list-count">1</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2019/01/">January 2019</a><span class="archive-list-count">3</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2018/12/">December 2018</a><span class="archive-list-count">2</span></li></ul>
        </div>
    </div>


            
                
    <div class="widget-wrap widget-list">
        <h3 class="widget-title">tags</h3>
        <div class="widget">
            <ul class="tag-list"><li class="tag-list-item"><a class="tag-list-link" href="/tags/CS231n/">CS231n</a><span class="tag-list-count">1</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/crawling/">crawling</a><span class="tag-list-count">2</span></li></ul>
        </div>
    </div>


            
                
    <div class="widget-wrap widget-float">
        <h3 class="widget-title">tag cloud</h3>
        <div class="widget tagcloud">
            <a href="/tags/CS231n/" style="font-size: 10px;">CS231n</a> <a href="/tags/crawling/" style="font-size: 20px;">crawling</a>
        </div>
    </div>


            
                
    <div class="widget-wrap widget-list">
        <h3 class="widget-title">links</h3>
        <div class="widget">
            <ul>
                
                    <li>
                        <a href="http://hexo.io">Hexo</a>
                    </li>
                
            </ul>
        </div>
    </div>


            
        
    </div>
    <script async src="https://pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
<!-- 사이드바 -->
<ins class="adsbygoogle"
     style="display:block"
     data-ad-client="ca-pub-4604833066889492"
     data-ad-slot="3275421833"
     data-ad-format="auto"
     data-full-width-responsive="true"></ins>
<script>
     (adsbygoogle = window.adsbygoogle || []).push({});
</script>

</aside>

                </div>
            </div>
        </div>
        <footer id="footer">
    <div class="container">
        <div class="container-inner">
            <a id="back-to-top" href="javascript:;"><i class="icon fa fa-angle-up"></i></a>
            <div class="credit">
                <h1 class="logo-wrap">
                    <a href="/" class="logo"></a>
                </h1>
                <p>&copy; 2020 HeungBae Lee</p>
                <p>Powered by <a href="//hexo.io/" target="_blank">Hexo</a>. Theme by <a href="//github.com/ppoffice" target="_blank">PPOffice</a></p>
            </div>
            <div class="footer-plugins">
              
    


            </div>
        </div>
    </div>
</footer>

        
    
    <script>
    var disqus_shortname = 'hexo-theme-hueman';
    
    
    var disqus_url = 'https://heung-bae-lee.github.io/2020/03/03/data_engineering_10/';
    
    (function() {
    var dsq = document.createElement('script');
    dsq.type = 'text/javascript';
    dsq.async = true;
    dsq.src = '//' + disqus_shortname + '.disqus.com/embed.js';
    (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
    })();
    </script>




    
        <script src="/libs/lightgallery/js/lightgallery.min.js"></script>
        <script src="/libs/lightgallery/js/lg-thumbnail.min.js"></script>
        <script src="/libs/lightgallery/js/lg-pager.min.js"></script>
        <script src="/libs/lightgallery/js/lg-autoplay.min.js"></script>
        <script src="/libs/lightgallery/js/lg-fullscreen.min.js"></script>
        <script src="/libs/lightgallery/js/lg-zoom.min.js"></script>
        <script src="/libs/lightgallery/js/lg-hash.min.js"></script>
        <script src="/libs/lightgallery/js/lg-share.min.js"></script>
        <script src="/libs/lightgallery/js/lg-video.min.js"></script>
    
    
        <script src="/libs/justified-gallery/jquery.justifiedGallery.min.js"></script>
    
    
        <script type="text/x-mathjax-config">
            MathJax.Hub.Config({ tex2jax: { inlineMath: [['$','$'], ['\\(','\\)']] } });
        </script>
        <script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.1/MathJax.js?config=TeX-MML-AM_CHTML"></script>
    



<!-- Custom Scripts -->
<script src="/js/main.js"></script>

    </div>
<script type="text/x-mathjax-config">
    MathJax.Hub.Config({
        tex2jax: {
            inlineMath: [ ["$","$"], ["\\(","\\)"] ],
            skipTags: ['script', 'noscript', 'style', 'textarea', 'pre', 'code'],
            processEscapes: true
        }
    });
    MathJax.Hub.Queue(function() {
        var all = MathJax.Hub.getAllJax();
        for (var i = 0; i < all.length; ++i)
            all[i].SourceElement().parentNode.className += ' has-jax';
    });
</script>
<!-- <script src="http://cdn.mathjax.org/mathjax/latest/MathJax.js?config=TeX-AMS-MML_HTMLorMML"></script> -->
<script src='https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.2/MathJax.js?config=TeX-MML-AM_CHTML'></script>

</body>
</html>
